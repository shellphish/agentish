FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Copy and install requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy backend (sandbox server)
COPY backend/server_sandbox.py backend/

# Copy compiler (needed for ASL compilation)
COPY compiler/ compiler/

# Copy frontend (sandbox UI)
COPY frontend/sandbox.html frontend/
COPY frontend/sandbox.js frontend/
COPY frontend/styles.css frontend/

# Create directories for submissions and logs
RUN mkdir -p /workspace/submissions /workspace/logs output

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV SANDBOX_CONFIG_PATH=/config/sandbox.yml
ENV CHALLENGISH_CONFIG_PATH=/config/challengish.yml
ENV SUBMISSION_LOG_DIR=/workspace/logs
ENV SUBMISSION_OUTPUT_DIR=/workspace/submissions

EXPOSE 8001

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

CMD ["python3", "backend/server_sandbox.py", "--port", "8001"]
