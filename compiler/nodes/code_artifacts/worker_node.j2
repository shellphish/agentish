#{ Template for worker node - Similar to LLM but routes back to calling node - Single Global State #}
def worker_{{ node_id }}_node(global_state: GlobalState) -> Command:
    """Worker Node {{ node_id }}: {{ title }}
    
    Worker node that processes tasks assigned by LLM nodes.
    """
    
    # Build message list
    messages = []
    
    # Add system prompt
    system_prompt_rendered = render_template({{ system_prompt|tojson }}, global_state)
    if system_prompt_rendered:
        messages.append(SystemMessage(content=system_prompt_rendered))
    
    # Add conversation history from node-specific messages in global state
    messages.extend(global_state.get("node_{{ node_id }}_messages", []))
    
    # Get human message from global state (task from calling LLM)
    global_messages = global_state.get("messages", [])
    if global_messages:
        last_global_message = global_messages[-1]
        if hasattr(last_global_message, 'content'):
            messages.append(HumanMessage(content=last_global_message.content))
    
    # Invoke the model
    {%- if structured_output_enabled %}
    model_with_output = model_{{ node_id }}.with_structured_output({{ structured_output_schema_class }})
    response = model_with_output.invoke(messages)
    {%- else %}
    response = model_{{ node_id }}.invoke(messages)
    {%- endif %}
    
    {% if has_tools %}
    # Check for tool calls (iteration limit enforced in tool node)
    if hasattr(response, 'tool_calls') and response.tool_calls:
        # Continue to worker's tool node
        return Command(
            update={
                "count": 1,
                "messages": [response],
                "node_{{ node_id }}_messages": [response],
                "node_{{ node_id }}_llm_calls": 1
            },
            goto="tool_worker_{{ node_id }}_node"
        )
    else:
        # Done - route back to calling node
        return Command(
            update={
                "count": 1,
                "messages": [response],
                "node_{{ node_id }}_messages": [response],
                "node_{{ node_id }}_llm_calls": 1,
                "node_{{ node_id }}_tool_iteration_count": 0
            },
            goto="{{ return_node }}"
        )
    {% else %}
    # No tools - route back immediately
    return Command(
        update={
            "count": 1,
            "messages": [response],
            "node_{{ node_id }}_messages": [response],
            "node_{{ node_id }}_llm_calls": 1
        },
        goto="{{ return_node }}"
    )
    {% endif %}
